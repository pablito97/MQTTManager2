@page "/configurationDialog"

@using MQTTManager.DB.Model;
@using MQTTManager.DB.Model.Enum;
@using MQTTManager.Services;

@inject IDialogService DialogService
@inject ISnackbar Snackbar
@inject IBrokerConfigurationService ConfigurationService

<MudDialog>
    <TitleContent>
        <MudText Typo="Typo.h6">
            Autoryzacja brokera @brokerConfig.Name
        </MudText>
    </TitleContent>
    <DialogContent>
        <MudGrid>
            <MudItem md="6">
                <MudTextField T="string" @bind-Value="brokerConfig.BrokerAuthorization.Login" Label="Login" Required="true"></MudTextField>
            </MudItem>
            <MudItem md="6">
                <MudTextField T="string" @bind-Value="brokerConfig.BrokerAuthorization.HashPassword" Label="Hasło" Required="true"></MudTextField>
            </MudItem>
            <MudItem md="12">
                <MudTextField T="string" @bind-Value="brokerConfig.BrokerAuthorization.Key" Label="Klucz" Required="true"></MudTextField>
            </MudItem>
            <MudItem md="4">
                <MudSelect @bind-Value="brokerConfig.Authorization" Label="Typ autoryzacji" Required="true">
                    @foreach (AuthorizationTypes authorization in Enum.GetValues(typeof(AuthorizationTypes)))
                    {
                        <MudSelectItem Value="@authorization" />
                    }
                </MudSelect>
            </MudItem>
        </MudGrid>
    </DialogContent>
    <DialogActions>
        <MudButton Color="Color.Warning" OnClick="Send">Zatwierdź</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] MudDialogInstance MudDialog { get; set; }
    [Parameter] public BrokerConfigurationModel brokerConfig { get; set; }
    public BrokerAuthorizationModel brokerAuthorization { get; set; }

    private async Task Send()
    {
        if (string.IsNullOrWhiteSpace(brokerConfig.Name) || brokerConfig.Port == 0)
        {
            Snackbar.Add("Podaj prawidłowe dane do konfiguracji", Severity.Warning);
            return;
        }

        if (await ConfigurationService.AddBrokerConfiguration(brokerConfig))
        {
            Snackbar.Add("Dodano nową konfiguracje", Severity.Success);
            MudDialog.Close(DialogResult.Ok(""));
        }
        else
        {
            Snackbar.Add("Nie dodano nowej konfiguracji", Severity.Error);
        }
    }

    private void Cancel()
    {
        MudDialog.Cancel();
    }
}
